@page "/media"
@using dominikz.Client.Utils
@using dominikz.Domain.Enums
@using dominikz.Domain.Extensions
@using dominikz.Domain.ViewModels.Media
@using dominikz.Client.Tables
@using dominikz.Client.Extensions
@using dominikz.Domain.Enums.Media

<PageTitle>Media</PageTitle>

<div class="media">

    <MediaCarousel Data="_previews"/>

    <TextBox @ref="_searchbox"
             DelayInputTrigger="true"
             Placeholder="Search ..."
             Icon="fa-solid fa-magnifying-glass"
             ValueChanged="@((value) => NavManager!.AttachOrUpdateRawQueryParam(QueryNames.Media.Search, value))"/>

    <TabControl @ref="_categoryTabCtrl" OnPageChanged="OnPageChanged">

        <TabPage Id="@((int)MediaCategoryEnum.Movie)" Text="@(EnumFormatter.ToString(MediaCategoryEnum.Movie))">

            <ChipSelect T="MovieGenresFlags"
                        AllowExpand=true
                        Title="Genres"
                        @ref="_movieGenreSelect"
                        SelectedChanged="@((value) => NavManager!.AttachOrUpdateQueryParam<MovieGenresFlags>(QueryNames.Media.Movie.Genre, value.Count > 0 ? value.First() : null))"
                        Values="Enum.GetValues<MovieGenresFlags>()[1..].ToList()"/>

            <div class="flex-row gap">

                @if (_hasCreatePermission)
                {
                    <div class="admin-menu-element gap">
                        <IconButton OnClick="@(() => NavManager!.NavigateTo("/media/movie/edit"))" Icon="fa-solid fa-circle-plus"/>
                    </div>
                }

                <div class="menu-element gap">
                    <i class="fa-solid fa-border-top-left"></i>
                    <Switch @bind-State="_isTableView"/>
                    <i class="fa-solid fa-bars-staggered"></i>
                </div>

                <div class="menu-element">
                    <IconButton OnClick="OnCopyLinkClicked" Icon="fa-solid fa-link"/>
                    <IconButton OnClick="OnCreateCURLClicked" Icon="fa-solid fa-code"/>
                </div>
            </div>

            @if (_isTableView)
            {
                <Table T="MovieVm" Values="@_movies" Columns="@MovieTableDefinition.Columns" ShowIndex="true"></Table>
            }
            else
            {
                <div class="media-grid">
                    @foreach (var movie in _movies)
                    {
                        <HorizontalCard ImageUrl="@movie.ImageUrl"
                                        Title="@movie.Title"
                                        OnClick="() => NavigateToMovie(movie.Id)">

                            <div class="flex-column gap">
                                <span>@movie.Year</span>
                                <Rating Value="@movie.Rating"/>
                                <div class="flex-row gap">
                                    @foreach (var genre in movie.Genres.GetFlags().ToArray()[1..])
                                    {
                                        <span>@EnumFormatter.ToString(genre)&nbsp;</span>
                                    }
                                </div>
                            </div>

                        </HorizontalCard>
                    }
                </div>
            }

        </TabPage>

        <TabPage Id="@((int)MediaCategoryEnum.Book)" Text="@(EnumFormatter.ToString(MediaCategoryEnum.Book))">

            <ChipSelect T="BookGenresFlags"
                        AllowExpand=true
                        Title="Genres"
                        @ref="_bookGenreSelect"
                        SelectedChanged="@((value) => NavManager!.AttachOrUpdateQueryParam<BookGenresFlags>(QueryNames.Media.Book.Genre, value.Count > 0 ? value.First() : null))"
                        Values="Enum.GetValues<BookGenresFlags>()[1..].ToList()"/>

            <ChipSelect T="BookLanguageEnum"
                        Title="Genres"
                        @ref="_bookLanguageSelect"
                        SelectedChanged="@((value) => NavManager!.AttachOrUpdateQueryParam<BookLanguageEnum>(QueryNames.Media.Book.Language, value.Count > 0 ? value.First() : null))"
                        Values="Enum.GetValues<BookLanguageEnum>().ToList()"/>

            <div class="flex-row gap">

                @if (_hasCreatePermission)
                {
                    <div class="admin-menu-element gap">
                        <IconButton OnClick="@(() => NavManager!.NavigateTo("/media/book/edit"))" Icon="fa-solid fa-circle-plus"/>
                    </div>
                }

                <div class="menu-element gap">
                    <i class="fa-solid fa-border-top-left"></i>
                    <Switch @bind-State="_isTableView"/>
                    <i class="fa-solid fa-bars-staggered"></i>
                </div>

                <div class="menu-element">
                    <IconButton OnClick="OnCopyLinkClicked" Icon="fa-solid fa-link"/>
                    <IconButton OnClick="OnCreateCURLClicked" Icon="fa-solid fa-code"/>
                </div>
            </div>

            @if (_isTableView)
            {
                <Table T="BookVm" Values="@_books" Columns="@BookTableDefinition.Columns" ShowIndex="true"></Table>
            }
            else
            {
                <div class="media-grid">
                    @foreach (var book in _books)
                    {
                        <HorizontalCard ImageUrl="@book.ImageUrl" Title="@book.Title">
                            <span>@book.Year</span>
                            <span>@book.Author</span>
                            <span>@EnumFormatter.ToString(book.Language)</span>
                            <div class="flex-row gap">
                                @foreach (var genre in book.Genres.GetFlags().ToArray()[1..])
                                {
                                    <span>@EnumFormatter.ToString(genre)&nbsp;</span>
                                }
                            </div>
                        </HorizontalCard>
                    }
                </div>
            }

        </TabPage>

        <TabPage Id="@((int)MediaCategoryEnum.Game)" Text="@(EnumFormatter.ToString(MediaCategoryEnum.Game))">

            <ChipSelect T="GameGenresFlags"
                        AllowExpand=true
                        Title="Genres"
                        @ref="_gameGenreSelect"
                        SelectedChanged="@((value) => NavManager!.AttachOrUpdateQueryParam<GameGenresFlags>(QueryNames.Media.Game.Genre, value.Count > 0 ? value.First() : null))"
                        Values="Enum.GetValues<GameGenresFlags>()[1..].ToList()"/>

            <ChipSelect T="GamePlatformEnum"
                        Title="Genres"
                        @ref="_gamePlatformSelect"
                        SelectedChanged="@((value) => NavManager!.AttachOrUpdateQueryParam<GamePlatformEnum>(QueryNames.Media.Game.Platform, value.Count > 0 ? value.First() : null))"
                        Values="Enum.GetValues<GamePlatformEnum>().ToList()"/>

            <div class="flex-row gap">

                @if (_hasCreatePermission)
                {
                    <div class="admin-menu-element gap">
                        <IconButton OnClick="@(() => NavManager!.NavigateTo("/media/game/edit"))" Icon="fa-solid fa-circle-plus"/>
                    </div>
                }

                <div class="menu-element gap">
                    <i class="fa-solid fa-border-top-left"></i>
                    <Switch @bind-State="_isTableView"/>
                    <i class="fa-solid fa-bars-staggered"></i>
                </div>

                <div class="menu-element">
                    <IconButton OnClick="OnCopyLinkClicked" Icon="fa-solid fa-link"/>
                    <IconButton OnClick="OnCreateCURLClicked" Icon="fa-solid fa-code"/>
                </div>
            </div>

            @if (_isTableView)
            {
                <Table T="GameVm" Values="@_games" Columns="@GameTableDefinition.Columns" ShowIndex="true"></Table>
            }
            else
            {
                <div class="media-grid">
                    @foreach (var game in _games)
                    {
                        <HorizontalCard ImageUrl="@game.ImageUrl" Title="@game.Title">
                            <span>@game.Year</span>
                            <span>@EnumFormatter.ToString(game.Platform)</span>
                            <div class="flex-row gap">
                                @foreach (var genre in game.Genres.GetFlags().ToArray()[1..])
                                {
                                    <span>@EnumFormatter.ToString(genre)&nbsp;</span>
                                }
                            </div>
                        </HorizontalCard>
                    }
                </div>
            }

        </TabPage>

    </TabControl>

</div>